name: newman-compare-ohlc

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 3 * * 1-5" # 09:00 IST Mon-Fri (GitHub cron is UTC)

jobs:
  run-newman:
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      USERNAME_OR_EMAIL: ${{ secrets.USERNAME_OR_EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      TOTP_SECRET_BASE32: ${{ secrets.TOTP_SECRET_BASE32 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Newman + reporters
        run: |
          npm i -g newman
          npm i -g newman-reporter-htmlextra

      - name: Generate TOTP (6-digit)
        run: |
          node ./gen_totp.js "$TOTP_SECRET_BASE32" > /tmp/totp.txt
          echo "totp=$(cat /tmp/totp.txt)" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 1) DataContract (Login + others) - once
      # ------------------------------------------------------------
      - name: Run Newman (DataContract - once)
        run: |
          mkdir -p artifacts
          newman run "./Contract Testing.postman_collection.json" \
            -e "./XTL.postman_environment.json" \
            --folder "DataContract" \
            --iteration-count 1 \
            --env-var "BASE_URL=$BASE_URL" \
            --env-var "USERNAME_OR_EMAIL=$USERNAME_OR_EMAIL" \
            --env-var "PASSWORD=$PASSWORD" \
            --env-var "totp=$totp" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export "artifacts/newman-datacontract.html" \
            --reporter-junit-export "artifacts/newman-datacontract.xml" \
            --export-environment "artifacts/env.after.login.json" \
            --suppress-exit-code

      # ------------------------------------------------------------
      # 2) APIContract: OpportunitiesContract - once
      # ------------------------------------------------------------
      - name: Run Newman (OpportunitiesContract - once)
        run: |
          newman run "./Contract Testing.postman_collection.json" \
            -e "artifacts/env.after.login.json" \
            --folder "OpportunitiesContract" \
            --iteration-count 1 \
            --env-var "BASE_URL=$BASE_URL" \
            --env-var "totp=$totp" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export "artifacts/newman-opportunitiescontract.html" \
            --reporter-junit-export "artifacts/newman-opportunitiescontract.xml" \
            --suppress-exit-code

      # ------------------------------------------------------------
      # 3) APIContract: Opportunities-loop - 5 iterations (5 symbols)
      # ------------------------------------------------------------
      - name: Run Newman (Opportunities-loop - 5 symbols)
        run: |
          newman run "./Contract Testing.postman_collection.json" \
            -e "artifacts/env.after.login.json" \
            --folder "Opportunities-loop" \
            --iteration-count 5 \
            --env-var "symbols_csv=EURUSD,GBPUSD,USDJPY,USDCHF,XAUUSD" \
            --env-var "BASE_URL=$BASE_URL" \
            --env-var "totp=$totp" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export "artifacts/newman-opportunities-loop.html" \
            --reporter-junit-export "artifacts/newman-opportunities-loop.xml" \
            --suppress-exit-code

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-contract-report
          path: artifacts/
